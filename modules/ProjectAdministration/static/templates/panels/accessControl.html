<div>
    <h2>Access control</h2>

    <div class="settings-group">
        <input type="checkbox" id="public-checkbox" />
        <label for="public-checkbox">Public project</label>
        <p style="font-style:italic;">If the project is set to be public, anyone with an account can join it
        by following the respective link. Otherwise joining a project requires knowing the appropriate link below.</p>

        <span>Secret link:</span>
        <input id="field-secret-token" type="text" readonly style="width:calc(100% - 180px)" />
        <button id="renew-secret-token" class="btn btn-sm btn-light">Renew</button>
        <br />


        <input type="checkbox" id="demo-checkbox" />
        <label for="demo-checkbox">Demo mode</label>
        <p style="font-style:italic;">Demo mode opens the project to anyone (even without an account)
        and disables saving annotations and the AI model, if configured.
        Existing annotations will be retained as they are.</p>

        <div id="quiz-properties" style="display:none">
            <!-- quiz game properties -->
            <input type="checkbox" id="quizgame-enabled-checkbox" />
            <label for="quizgame-enabled-checkbox">Quiz mode</label>
            <p style="font-style:italic">In quiz mode, users can label a
            predefined number of images; provided labels get compared to
            existing labels and the current user obtains a score.<br />
            Quiz mode requires the project to be in demo mode.</p>

            <label for="quizgame-num-images-per-run">Number of images per run:</label>
            <input id="quizgame-num-images-per-run" type="number" min="1" max="8192" value="10" />
            <br />
            <div id="quizgame-threshold-properties">
                <label id="quizgame-threshold-label" for="quizgame-threshold-range">Threshold for correct annotations:</label>
                <input id="quizgame-threshold-range" type="range" min="1" max="100" value="50" />
                <span id="quizgame-threshold-val">0.5</span>
            </div>

            <!-- TODO: add target user account? -->
        </div>

        <!-- <div>
            <button id="proj-settings-save-button" class="btn btn-primary" style="float:right">Save</button>
        </div> -->
    </div>


    <!-- User list -->
    <h3>Users</h3>

    <!-- TODO: implement search function to add new users -->
    <div id="letter-picker"></div>
    <table id="ac-table" class="ac-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-users" /></th>
                <th>Name</th>
                <th>Administrator</th>
                <th>Admitted until</th>
                <th>Blocked until</th>
            </tr>
        </thead>
        <tbody id="users-list"></tbody>
    </table>
    <div>
        <span>Selection:</span>
        <select id="selection-action">
            <option value="elevate-admin" name="user-action">elevate to project administrators</option>
            <option value="revoke-admin" name="user-action">revoke administrator privileges</option>
            <option value="admitUntil" name="user-action">admit until</option>
            <option value="blockUntil" name="user-action">block until</option>
            <option value="deregister" name="user-action">remove from project</option>
        </select>
        <input type="text" id="datetime-specifier" style="display:none" />
        <button id="selection-action-proceed" class="btn btn-sm btn-light">Apply</button>
    </div>
</div>
<style>
    .ac-table {
        width: 100%;
        border: 1px solid #aaa;
    }

    .ac-table thead {
        background: #5f5f5f;
        font-weight: bold;
    }

    .ac-table tbody {
        overflow-x: hidden;
        overflow-y: auto;
        height: calc(100vh - 620px);
    }

    .ac-table thead, .ac-table tbody {
        display: block;
        padding-left: 5px;
        padding-right: 5px;
    }

    .ac-table td {
        padding-right: 5px;
    }
</style>
<link rel="stylesheet" href="/static/general/libs/datetimepicker/jquery.datetimepicker.css?v={{ version }}" />
<link rel="stylesheet" href="/static/general/css/letterPicker.css?v={{ version }}" />
<script type="text/javascript" src="/static/general/libs/datetimepicker/jquery.datetimepicker.js?v={{ version }}"></script>
<script type="text/javascript" src="/static/general/js/letterPicker.js?v={{ version }}"></script>
<script src="/static/general/js/tableWidthAdjuster.js?v={{ version }}"></script>
<script type="text/javascript">
    function getUsers() {
        let uList = $('#users-list');
        uList.empty();
        return $.ajax({
            url: window.baseURL + 'getUsers',
            method: 'GET',
            success: function(data) {
                if(data.hasOwnProperty('users')) {
                    let usernames = [];
                    for(var i=0; i<data['users'].length; i++) {
                        let uName = data['users'][i]['username'];
                        usernames.push(uName);
                        var uName_vis = uName;
                        let isAdmin = data['users'][i]['isadmin'] ? '<img src="/static/general/img/success.svg"></img>' : '<img src="/static/general/img/error.svg"></img>';
                        var admittedUntil = data['users'][i]['admitted_until'];
                        if(typeof(admittedUntil) === 'number') {
                            try {

                                admittedUntil = new Date(admittedUntil * 1000).toDateString();
                            } catch {
                                admittedUntil = '';
                            }
                        } else {
                            admittedUntil = '';
                        }
                        var blockedUntil = data['users'][i]['blocked_until'];
                        if(typeof(blockedUntil) === 'number') {
                            try {
                                blockedUntil = new Date(blockedUntil * 1000).toDateString();
                            } catch {
                                blockedUntil = '';
                            }
                        } else {
                            blockedUntil = '';
                        }
                        let markup = $('<tr id="'+uName+'"></tr>');
                        if(uName === window.user) {
                            var checkbox = $('<input type="checkbox" id="'+uName+'__select" disabled />');
                            uName_vis += ' (You)';
                        } else {
                            var checkbox = $('<input type="checkbox" id="'+uName+'__select" />');
                        }
                        markup.append($('<td></td>').append(checkbox));
                        markup.append($('<td>'+uName_vis+'</td>'));
                        markup.append($('<td>'+isAdmin+'</td>'));
                        markup.append($('<td>'+admittedUntil+'</td>'));
                        markup.append($('<td>'+blockedUntil+'</td>'));
                        uList.append(markup);
                    }

                    // set up letter picker
                    window.letterPicker = new LetterPicker($('#letter-picker'),
                        {
                            data: usernames,
                            allowMultipleSelection: false
                        }
                    );
                    window.letterPicker.on('click', function() {
                        filterUsersTable();
                    });
                }
            },
            error: function(xhr, status, error) {
                window.messager.addMessage('An error occurred while trying to retrieve project members (message: "' + error + '").', 'error', 0);
            },
            statusCode: {
                401: function(xhr) {
                    return window.renewSessionRequest(xhr, function() {
                        return getUsers();
                    });
                }
            }
        });
    }

    function filterUsersTable() {
        let letters = window.letterPicker.getSelected();
        let alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        let table = $('#users-list');
        table.children().each(function() {
            let initial = $(this).attr('id').slice(0,1).toUpperCase();
            if(letters === undefined || letters.length === 0) {
                // everything deselected; show all
                $(this).show();
            } else if(letters.includes(initial)) {
                $(this).show();
            } else if(letters.includes('#') && !alphabet.includes(initial)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    window.save = function() {
        // get quiz properties first
        let quizProperties = {
            num_images: parseInt($('#quizgame-num-images-per-run').val()),
            threshold: parseFloat($('#quizgame-threshold-range').val()) / 100.0
        }

        return $.ajax({
            url: window.baseURL + 'saveProjectConfiguration',
            method: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                'demoMode': $('#demo-checkbox').prop('checked'),
                'isPublic': $('#public-checkbox').prop('checked'),
                'quizMode': $('#quizgame-enabled-checkbox').prop('checked') && $('#demo-checkbox').prop('checked'),
                'quiz_properties': quizProperties
            }),
            success: function(data) {
                if(data['success']) {
                    window.messager.addMessage('Settings saved successfully.', 'success');
                } else {
                    window.messager.addMessage('Settings could not be saved due to an unknown error.', 'error', 0);
                }
            },
            statusCode: {
                401: function(xhr) {
                    return window.renewSessionRequest(xhr, function() {
                        window.save();
                    });
                }
            }
        });
    }

    function setUserAuthentication() {
        let users = [];
        let uList = $('#users-list');
        uList.children().each(function() {
            let chckbx = $('#'+$(this).attr('id')+'__select');
            if($(this).is(':visible') && chckbx.prop('checked')) {
                users.push($(this).attr('id'));
            }
        });
        if(users.length === 0) return;

        let timestamp = null;
        try {
            timestamp = new Date($('#datetime-specifier').val()).getTime() / 1000;
        } catch {}
        let privilege = $('#selection-action').val();
        switch(privilege) {
            case 'elevate-admin':
                privilege = {
                    'isAdmin': true
                };
                break;
            case 'revoke-admin':
                privilege = {
                    'isAdmin': false
                };
                break;
            case 'admitUntil':
                privilege = {
                    'admitted_until': timestamp
                };
                break;
            case 'blockUntil':
                privilege = {
                    'blocked_until': timestamp
                };
                break;
            case 'deregister':
                privilege = {
                    'remove': true
                };
                break;
        }

        return $.ajax({
            url: window.baseURL + 'setPermissions',
            method: 'POST',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                users: users,
                privileges: privilege
            }),
            success: function(response) {
                if(response['status'] === 0) {
                    window.messager.addMessage('User permissions changed successfully.', 'success');
                }
                return getUsers().then(function() {
                    return filterUsersTable();
                });
            },
            error: function(xhr, status, error) {
                window.messager.addMessage('Could not set user permissions (message: "' + error + '").', 'error', 0);
            },
            statusCode: {
                401: function(xhr) {
                    return window.renewSessionRequest(xhr, function() {
                        return setUserAuthentication();
                    });
                }
            }
        })
    }

    // quiz game
    window.quizProperties = {   // defaults
        enabled: false,
        num_images: 10,
        threshold: 0.5
    }
    function getQuizgameProperties() {
        return $.ajax({
            url: window.baseURL + 'getProjectImmutables',
            method: 'GET',
            success: function(data) {
                window.projectImmutables = data['immutables'];
                window.annotationType = window.projectImmutables['predictionType'];
                window.predictionType = window.projectImmutables['predictionType'];

                // adjust quizgame properties based on annotation type
                if(window.annotationType === 'labels') {
                    $('#quizgame-threshold-properties').hide();     // label is either correct or wrong
                } else if(window.annotationType === 'points') {
                    $('#quizgame-threshold-label').html('Maximum relative distance to closest point:');
                } else if(window.annotationType === 'boundingBoxes') {
                    $('#quizgame-threshold-label').html('Minimum intersection-over-union with closest bounding box:');
                } else if(window.annotationType === 'segmentationMasks') {
                    $('#quizgame-threshold-properties').hide();     // accuracy can directly be calculated in percentages
                }

                // populate quiz property controls
                $('#quizgame-enabled-checkbox').prop('checked', window.quizProperties['enabled']);
                $('#quizgame-num-images-per-run').val(window.quizProperties['num_images']);
                if(typeof(window.quizProperties['threshold']) === 'number') {
                    $('#quizgame-threshold-range').val(100 * window.quizProperties['threshold']);
                    $('#quizgame-threshold-val').html(100 * window.quizProperties['threshold']);
                }

                $('#quiz-properties').show();
                $('#demo-checkbox').trigger('change');              // enable or disable quiz mode
                $('#quizgame-threshold-range').trigger('input');
            },
            error: function(xhr, status, error) {
                console.error(error);
                if(typeof(xhr) === 'object' && xhr.hasOwnProperty('status') && xhr['status'] !== 401) {
                    window.messager.addMessage('An error occurred while trying to load project properties (message: "' + error + '").', 'error', 0);
                }
            },
            statusCode: {
                401: function(xhr) {
                    return window.renewSessionRequest(xhr, function() {
                        return getQuizgameProperties();
                    });
                }
            }
        });
    }

    $(document).ready(function() {
        // table column widths
        window.adjustTableWidth(
            '#ac-table',
            [
                '20px',
                '140px',
                '120px',
                '160px',
                '160px'
            ],
            true,
            true
        );

        // general settings
        let promise = $.ajax({
            url: window.baseURL + 'getConfig',
            method: 'POST',
            data: JSON.stringify({
                'parameters': [
                    'ispublic',
                    'secret_token',
                    'demomode',
                    'quizmode',
                    'quiz_properties'
                ]
            }),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                settings = data['settings'];
                $('#public-checkbox').prop('checked', settings['ispublic']);
                $('#field-secret-token').val(window.location.host + '/' + window.project + '/enroll/'+settings['secret_token']);
                $('#demo-checkbox').prop('checked', settings['demomode']);

                if(settings.hasOwnProperty('quiz_properties') &&
                    typeof(settings['quiz_properties']) === 'object' && settings['quiz_properties'] !== null) {
                    window.quizProperties = settings['quiz_properties'];
                    window.quizProperties['enabled'] = settings['quizmode'];
                }
            },
            error: function(xhr, status, error) {
                console.log('ERROR:');
                console.log(data);
            }
        });

        // users list
        let uList = $('#users-list');
        $('#select-all-users').click(function() {
            let isChecked = $(this).prop('checked');
            $.each(uList.children(), function() {
                let chckbx = $('#'+$(this).attr('id')+'__select');
                if(!chckbx.attr('disabled')) {
                    chckbx.prop('checked', isChecked);
                }
            });
        });

        getSelectedUserAction = function() {
            return $('#selection-action [name=user-action]:checked').val();
        }

        promise = promise.done(function() {
            return getUsers();
        });

        // misc.
        $('#renew-secret-token').click(function() {
            $.ajax({
                url: window.baseURL + 'renewSecretToken',
                method: 'POST',
                success: function(data) {
                    if(data.hasOwnProperty('secret_token')) {
                        $('#field-secret-token').val(window.location.host +
                            window.project +
                            '/enroll/' + data['secret_token']);
                    } else {
                        $('#renew-secret-token').prop('disabled', true);
                        $('#field-secret-token').val('(sorry, an unknown error occurred)');
                    }
                },
                error: function(data) {
                    console.log('ERROR:')
                    console.log(data);
                }
            });
        });

        var now = new Date();

        $('#datetime-specifier').datetimepicker({
            startDate: now,
            minDateTime: now
        });

        $('#selection-action').change(function() {
            var action = getSelectedUserAction();
            if(action === 'admitUntil' || action === 'blockUntil') {
                $('#datetime-specifier').show();
            } else {
                $('#datetime-specifier').hide();
            }
        });

        $('#selection-action-proceed').click(function() {
            setUserAuthentication();
        });

        // $('#proj-settings-save-button').click(function() {
        //     window.save();      //TODO
        // });

        // quiz game
        $('#demo-checkbox').on('change', function() {
            let demoMode = $(this).prop('checked');
            let quizMode = $('#quizgame-enabled-checkbox').prop('checked');
            $('#quizgame-enabled-checkbox').prop('checked', demoMode && quizMode);
            $('#quiz-properties').find('input').each(function() {
                $(this).prop('disabled', !demoMode);
            });
        });
        $('#quizgame-threshold-range').on('input', function() {
            $('#quizgame-threshold-val').html(parseInt($(this).val()) / 100.0);
        });
        promise = promise.done(function() {
            return getQuizgameProperties(quizProperties);
        });
        
        promise.done(function() {
            window.showLoadingOverlay(false);
        });
    });
</script>